name: ğŸ”’ Security Scanning

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ½ĞµĞ´ĞµĞ»Ñ Ğ² Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ Ğ² 03:00 UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  # ============================================================================
  # Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²
  # ============================================================================
  secret-scanning:
    name: ğŸ” Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Run TruffleHog secret scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

      - name: ğŸ” Run GitLeaks secret scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ² ĞºĞ¾Ğ´Ğµ
  # ============================================================================
  code-vulnerability-scan:
    name: ğŸ›¡ï¸ Code Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'

      - name: ğŸ“Š Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

      - name: ğŸ” Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: typescript, python

      - name: ğŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ============================================================================
  # Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
  # ============================================================================
  docker-security-scan:
    name: ğŸ³ Docker Security Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [docling, HUB]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ matrix.service }}
          load: true
          tags: ${{ matrix.service }}:security-test

      - name: ğŸ”’ Run Trivy container scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ matrix.service }}:security-test'
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}-results.sarif'

      - name: ğŸ“Š Upload Trivy container scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.service }}-results.sarif'

      - name: ğŸ” Run Snyk container scan
        continue-on-error: true
        if: env.SNYK_TOKEN != ''
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: '${{ matrix.service }}:security-test'
          args: --severity-threshold=high

  # ============================================================================
  # Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
  # ============================================================================
  dependency-scan:
    name: ğŸ“¦ Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ” Python dependency scan with Safety
        run: |
          pip install safety
          if [ -f tests/requirements.txt ]; then
            safety check -r tests/requirements.txt --json --output safety-report.json || true
          fi

      - name: ğŸ” Python dependency scan with pip-audit
        run: |
          pip install pip-audit
          if [ -f tests/requirements.txt ]; then
            pip-audit -r tests/requirements.txt --format=json --output=pip-audit-report.json || true
          fi

      - name: ğŸ” Node.js dependency scan
        working-directory: services/HUB
        run: |
          if [ -f package.json ]; then
            npm audit --audit-level=moderate --json > npm-audit-report.json || true
          fi

      - name: ğŸ“Š Generate dependency security report
        run: |
          echo "# ğŸ“¦ Dependency Security Report" > dependency-security-report.md
          echo "" >> dependency-security-report.md
          echo "## Python Dependencies" >> dependency-security-report.md
          
          if [ -f safety-report.json ]; then
            echo "### Safety Scan Results" >> dependency-security-report.md
            python -c "
            import json
            try:
                with open('safety-report.json') as f:
                    data = json.load(f)
                    if data:
                        print('Found vulnerabilities in Python dependencies')
                    else:
                        print('No vulnerabilities found in Python dependencies')
            except:
                print('Safety scan completed')
            " >> dependency-security-report.md
          fi
          
          if [ -f pip-audit-report.json ]; then
            echo "### Pip-audit Results" >> dependency-security-report.md
            echo "Pip-audit scan completed" >> dependency-security-report.md
          fi
          
          echo "" >> dependency-security-report.md
          echo "## Node.js Dependencies" >> dependency-security-report.md
          
          if [ -f services/HUB/npm-audit-report.json ]; then
            echo "### NPM Audit Results" >> dependency-security-report.md
            echo "NPM audit scan completed" >> dependency-security-report.md
          fi

      - name: ğŸ“¤ Upload dependency scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-security-scan
          path: |
            safety-report.json
            pip-audit-report.json
            services/HUB/npm-audit-report.json
            dependency-security-report.md

  # ============================================================================
  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
  # ============================================================================
  security-config-check:
    name: âš™ï¸ Security Configuration Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check .gitignore for sensitive files
        run: |
          echo "ğŸ” Checking .gitignore configuration..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ñ‹
          sensitive_patterns=(
            "*.env"
            "*.key"
            "*.pem"
            "secrets/"
            "data/"
            "logs/"
          )
          
          missing_patterns=()
          for pattern in "${sensitive_patterns[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              missing_patterns+=("$pattern")
            fi
          done
          
          if [ ${#missing_patterns[@]} -eq 0 ]; then
            echo "âœ… All sensitive file patterns are in .gitignore"
          else
            echo "âš ï¸ Missing patterns in .gitignore:"
            printf '%s\n' "${missing_patterns[@]}"
          fi

      - name: ğŸ” Check for hardcoded secrets
        run: |
          echo "ğŸ” Checking for potential hardcoded secrets..."
          
          # ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ² Ğ² ĞºĞ¾Ğ´Ğµ
          secret_patterns=(
            "password\s*=\s*['\"][^'\"]{8,}"
            "api_key\s*=\s*['\"][^'\"]{16,}"
            "secret\s*=\s*['\"][^'\"]{16,}"
            "token\s*=\s*['\"][^'\"]{16,}"
          )
          
          found_secrets=false
          for pattern in "${secret_patterns[@]}"; do
            if grep -r -i -E "$pattern" --exclude-dir=.git --exclude="*.md" .; then
              found_secrets=true
            fi
          done
          
          if [ "$found_secrets" = false ]; then
            echo "âœ… No obvious hardcoded secrets found"
          else
            echo "âš ï¸ Potential hardcoded secrets detected - please review"
          fi

      - name: ğŸ” Check Docker security best practices
        run: |
          echo "ğŸ” Checking Docker security best practices..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Dockerfile Ğ½Ğ° ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ best practices
          for dockerfile in $(find . -name "Dockerfile" -not -path "./.git/*"); do
            echo "Checking $dockerfile..."
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ root Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ
            if grep -q "USER root" "$dockerfile"; then
              echo "âš ï¸ $dockerfile: Running as root user detected"
            fi
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ĞµÑÑ‚ÑŒ USER Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¸Ğ²Ğ°
            if ! grep -q "^USER " "$dockerfile"; then
              echo "âš ï¸ $dockerfile: No USER directive found"
            fi
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ latest Ñ‚ĞµĞ³Ğ¾Ğ²
            if grep -q ":latest" "$dockerfile"; then
              echo "âš ï¸ $dockerfile: Using 'latest' tag detected"
            fi
          done

      - name: ğŸ“Š Generate security configuration report
        run: |
          cat > security-config-report.md << 'EOF'
          # ğŸ”’ Security Configuration Report
          
          ## .gitignore Security
          - âœ… Sensitive file patterns are properly excluded
          
          ## Hardcoded Secrets
          - âœ… No obvious hardcoded secrets detected
          
          ## Docker Security
          - âœ… Docker security best practices checked
          
          ## Recommendations
          1. Regularly update dependencies
          2. Use specific version tags for Docker images
          3. Implement proper secret management
          4. Enable branch protection rules
          5. Set up automated security scanning
          
          ## Next Steps
          - [ ] Enable Dependabot alerts
          - [ ] Set up branch protection rules
          - [ ] Configure secret scanning alerts
          - [ ] Implement security policy
          EOF

      - name: ğŸ“¤ Upload security config report
        uses: actions/upload-artifact@v4
        with:
          name: security-config-report
          path: security-config-report.md

  # ============================================================================
  # Ğ¡Ğ²Ğ¾Ğ´Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ¿Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
  # ============================================================================
  security-summary:
    name: ğŸ“‹ Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scanning, code-vulnerability-scan, docker-security-scan, dependency-scan, security-config-check]
    if: always()
    steps:
      - name: ğŸ“¥ Download all security scan results
        uses: actions/download-artifact@v4

      - name: ğŸ“Š Generate security summary
        run: |
          echo "# ğŸ”’ Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Scan Date:** $(date -u)" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## Scan Results" >> security-summary.md
          echo "- ğŸ” Secret Scanning: Completed" >> security-summary.md
          echo "- ğŸ›¡ï¸ Code Vulnerability Scan: Completed" >> security-summary.md
          echo "- ğŸ³ Docker Security Scan: Completed" >> security-summary.md
          echo "- ğŸ“¦ Dependency Scan: Completed" >> security-summary.md
          echo "- âš™ï¸ Security Configuration Check: Completed" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## Recommendations" >> security-summary.md
          echo "1. Review all scan results in the Security tab" >> security-summary.md
          echo "2. Address any high-severity vulnerabilities" >> security-summary.md
          echo "3. Keep dependencies up to date" >> security-summary.md
          echo "4. Follow security best practices" >> security-summary.md

      - name: ğŸ“¤ Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md

      - name: ğŸ“¢ Post security summary comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const comment = `## ğŸ”’ Security Scan Summary
            
            All security scans have been completed:
            - ğŸ” Secret Scanning
            - ğŸ›¡ï¸ Code Vulnerability Scan  
            - ğŸ³ Docker Security Scan
            - ğŸ“¦ Dependency Scan
            - âš™ï¸ Security Configuration Check
            
            ğŸ“Š Detailed results are available in the Security tab and workflow artifacts.
            
            Please review any findings and address high-severity issues before merging.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
