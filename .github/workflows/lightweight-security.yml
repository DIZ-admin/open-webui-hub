name: ðŸ›¡ï¸ Lightweight Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
  # ============================================================================
  basic-security-check:
    name: ðŸ›¡ï¸ Basic Security Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Check for hardcoded secrets (basic patterns)
        run: |
          echo "ðŸ” Checking for potential hardcoded secrets..."
          
          # ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          secret_patterns=(
            "password\s*=\s*['\"][^'\"]{8,}"
            "api_key\s*=\s*['\"][^'\"]{16,}"
            "secret\s*=\s*['\"][^'\"]{16,}"
            "token\s*=\s*['\"][^'\"]{16,}"
            "AKIA[0-9A-Z]{16}"
            "sk_live_[0-9a-zA-Z]{24}"
            "sk_test_[0-9a-zA-Z]{24}"
            "ghp_[0-9a-zA-Z]{36}"
            "gho_[0-9a-zA-Z]{36}"
          )
          
          found_issues=false
          for pattern in "${secret_patterns[@]}"; do
            echo "Checking pattern: $pattern"
            if grep -r -i -E "$pattern" --exclude-dir=.git --exclude-dir=node_modules --exclude="*.md" . 2>/dev/null; then
              echo "âš ï¸ Potential secret found with pattern: $pattern"
              found_issues=true
            fi
          done
          
          if [ "$found_issues" = false ]; then
            echo "âœ… No obvious hardcoded secrets found"
          else
            echo "âš ï¸ Potential secrets detected - please review manually"
          fi

      - name: ðŸ” Check .gitignore for sensitive files
        run: |
          echo "ðŸ” Checking .gitignore configuration..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹
          sensitive_patterns=(
            "*.env"
            "*.key"
            "*.pem"
            "secrets/"
            "data/"
            "logs/"
            ".env.local"
            ".env.production"
          )
          
          missing_patterns=()
          for pattern in "${sensitive_patterns[@]}"; do
            if ! grep -q "$pattern" .gitignore 2>/dev/null; then
              missing_patterns+=("$pattern")
            fi
          done
          
          if [ ${#missing_patterns[@]} -eq 0 ]; then
            echo "âœ… All sensitive file patterns are in .gitignore"
          else
            echo "âš ï¸ Missing patterns in .gitignore:"
            printf '%s\n' "${missing_patterns[@]}"
            echo "Consider adding these patterns to .gitignore"
          fi

      - name: ðŸ” Check for exposed environment files
        run: |
          echo "ðŸ” Checking for exposed environment files..."
          
          # ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ð¾Ð¿Ð°ÑÐ½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
          dangerous_files=(
            ".env"
            ".env.local"
            ".env.production"
            "*.key"
            "*.pem"
            "id_rsa"
            "id_dsa"
            "*.p12"
            "*.pfx"
          )
          
          found_dangerous=false
          for pattern in "${dangerous_files[@]}"; do
            if find . -name "$pattern" -not -path "./.git/*" -not -path "./node_modules/*" | grep -q .; then
              echo "âš ï¸ Found potentially dangerous file: $pattern"
              find . -name "$pattern" -not -path "./.git/*" -not -path "./node_modules/*"
              found_dangerous=true
            fi
          done
          
          if [ "$found_dangerous" = false ]; then
            echo "âœ… No exposed sensitive files found"
          else
            echo "âš ï¸ Potentially sensitive files found - ensure they're in .gitignore"
          fi

      - name: ðŸ” Check Docker security best practices
        run: |
          echo "ðŸ” Checking Docker security best practices..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Dockerfile Ð½Ð° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ best practices
          for dockerfile in $(find . -name "Dockerfile" -not -path "./.git/*"); do
            echo "Checking $dockerfile..."
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ root Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
            if grep -q "USER root" "$dockerfile"; then
              echo "âš ï¸ $dockerfile: Running as root user detected"
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐµÑÑ‚ÑŒ USER Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¸Ð²Ð°
            if ! grep -q "^USER " "$dockerfile"; then
              echo "âš ï¸ $dockerfile: No USER directive found - consider adding non-root user"
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ latest Ñ‚ÐµÐ³Ð¾Ð²
            if grep -q ":latest" "$dockerfile"; then
              echo "âš ï¸ $dockerfile: Using 'latest' tag detected - consider using specific versions"
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð° COPY/ADD Ñ ÑˆÐ¸Ñ€Ð¾ÐºÐ¸Ð¼Ð¸ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸
            if grep -q "COPY \. " "$dockerfile" || grep -q "ADD \. " "$dockerfile"; then
              echo "âš ï¸ $dockerfile: Copying entire context - consider being more specific"
            fi
            
            echo "âœ… $dockerfile basic security check completed"
          done

      - name: ðŸ” Check for common vulnerabilities in dependencies
        run: |
          echo "ðŸ” Checking for known vulnerable patterns..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° package.json Ð½Ð° Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
          if [ -f services/HUB/package.json ]; then
            echo "Checking Node.js dependencies..."
            
            # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² (Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹)
            vulnerable_packages=(
              "event-stream"
              "flatmap-stream"
              "eslint-scope"
            )
            
            for package in "${vulnerable_packages[@]}"; do
              if grep -q "\"$package\"" services/HUB/package.json; then
                echo "âš ï¸ Found potentially vulnerable package: $package"
              fi
            done
            
            echo "âœ… Node.js dependency check completed"
          fi

      - name: ðŸ” Check for insecure configurations
        run: |
          echo "ðŸ” Checking for insecure configurations..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð½ÐµÐ±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð°Ñ…
          config_issues=false
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker Compose Ñ„Ð°Ð¹Ð»Ð¾Ð²
          for compose_file in $(find . -name "*.yml" -o -name "*.yaml" | grep -i compose); do
            echo "Checking $compose_file..."
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° privileged Ñ€ÐµÐ¶Ð¸Ð¼
            if grep -q "privileged.*true" "$compose_file"; then
              echo "âš ï¸ $compose_file: Privileged mode detected"
              config_issues=true
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° bind mount ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
            if grep -q ":/:" "$compose_file"; then
              echo "âš ï¸ $compose_file: Potential root filesystem bind mount"
              config_issues=true
            fi
          done
          
          if [ "$config_issues" = false ]; then
            echo "âœ… No obvious configuration security issues found"
          fi

      - name: ðŸ“Š Generate security summary
        run: |
          echo "ðŸ“Š Generating security summary..."
          cat > security-summary.md << 'EOF'
          # ðŸ›¡ï¸ Lightweight Security Check Summary
          
          ## Checks Performed
          - âœ… Hardcoded secrets scan (basic patterns)
          - âœ… .gitignore configuration check
          - âœ… Exposed environment files check
          - âœ… Docker security best practices
          - âœ… Common vulnerability patterns
          - âœ… Insecure configuration check
          
          ## Recommendations
          1. Regularly update dependencies
          2. Use specific version tags for Docker images
          3. Implement proper secret management
          4. Review and update .gitignore patterns
          5. Follow Docker security best practices
          
          ## Next Steps
          - Consider implementing more comprehensive security scanning
          - Set up dependency vulnerability monitoring
          - Implement automated secret scanning in CI/CD
          - Regular security audits
          EOF
          
          echo "âœ… Security summary generated"

      - name: ðŸ“¤ Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: lightweight-security-summary
          path: security-summary.md

      - name: ðŸ“Š Final summary
        run: |
          echo "ðŸŽ‰ Lightweight security check completed!"
          echo "âœ… Basic secret patterns: Checked"
          echo "âœ… .gitignore configuration: Checked"
          echo "âœ… Exposed files: Checked"
          echo "âœ… Docker security: Checked"
          echo "âœ… Dependency patterns: Checked"
          echo "âœ… Configuration security: Checked"
          echo ""
          echo "ðŸ“‹ This is a basic security check. For comprehensive security scanning,"
          echo "    consider using dedicated security tools like Snyk, Trivy, or SonarQube."
