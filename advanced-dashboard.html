<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open WebUI Hub - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <link rel="stylesheet" href="design-system.css">
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ */

        .system-status {
            display: flex;
            gap: var(--spacing-lg);
            align-items: center;
        }

        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ */
        .monitoring-card {
            position: relative;
            overflow: hidden;
        }

        .monitoring-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }

        .monitoring-card.warning::before {
            background: var(--warning-color);
        }

        .monitoring-card.danger::before {
            background: var(--danger-color);
        }

        .monitoring-card.success::before {
            background: var(--success-color);
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
        }

        .section-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--gray-700);
        }

        /* –ì—Ä—É–ø–ø—ã –¥–µ–π—Å—Ç–≤–∏–π */
        .action-group {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            flex-wrap: wrap;
        }

        /* –°—Ç–∞—Ç—É—Å—ã —Å–µ—Ä–≤–∏—Å–æ–≤ */
        .service-status {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ */
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .service-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--gray-700);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Open WebUI Hub - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
            <div class="system-status">
                <div class="status-indicator status-healthy" id="systemStatus">–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
                <div id="currentTime"></div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">üìä –û–±–∑–æ—Ä</button>
            <button class="nav-tab" onclick="showTab('services')">üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏</button>
            <button class="nav-tab" onclick="showTab('monitoring')">üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</button>
            <button class="nav-tab" onclick="showTab('logs')">üìã –õ–æ–≥–∏</button>
            <button class="nav-tab" onclick="showTab('config')">‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</button>
            <button class="nav-tab" onclick="showTab('backups')">üíæ –ë—ç–∫–∞–ø—ã</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –û–±–∑–æ—Ä -->
        <div id="overview" class="tab-content active">
            <div class="system-stats" id="systemStats">
                <!-- –°–∏—Å—Ç–µ–º–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>

            <div class="section-header">
                <h2 class="section-title">üîç –ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤</h2>
            </div>
            <div class="services-grid" id="servicesOverview">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏ -->
        <div id="services" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏</h2>
                <div class="action-group">
                    <button class="btn btn-success" onclick="startAllServices()">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-warning" onclick="restartAllServices()">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-danger" onclick="stopAllServices()">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ</button>
                </div>
            </div>
            <div class="services-grid" id="servicesManagement">
                <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏ -->
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ -->
        <div id="monitoring" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤</h2>
                <div class="action-group">
                    <button class="btn btn-primary" onclick="refreshMonitoring()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button class="btn btn-secondary" onclick="exportMetrics()">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
                </div>
            </div>
            <div class="services-grid" id="monitoringGrid">
                <!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ -->
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –õ–æ–≥–∏ -->
        <div id="logs" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">üìã –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–æ–≤</h2>
                <div class="action-group">
                    <select id="logServiceSelect" class="form-control" style="width: 200px;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadServiceLogs()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏</button>
                    <button class="btn btn-secondary" onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
            <div class="logs-container" id="logsContainer">
                –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
        <div id="config" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤</h2>
                <div class="action-group">
                    <select id="configServiceSelect" class="form-control" style="width: 200px;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadServiceConfig()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</button>
                </div>
            </div>
            <div id="configContainer">
                –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ë—ç–∫–∞–ø—ã -->
        <div id="backups" class="tab-content">
            <div class="section-header">
                <h2 class="section-title">üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞–º–∏</h2>
                <div class="action-group">
                    <select id="backupServiceSelect" class="form-control" style="width: 200px;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å</option>
                    </select>
                    <button class="btn btn-success" onclick="createBackup()">–°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø</button>
                    <button class="btn btn-info" onclick="loadBackups()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                </div>
            </div>
            <div id="backupsContainer">
                <!-- –°–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</h3>
                <button class="close-btn" onclick="closeModal('configModal')">&times;</button>
            </div>
            <div id="configModalBody">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="d-flex justify-between mt-5">
                <button class="btn btn-secondary" onclick="closeModal('configModal')">–û—Ç–º–µ–Ω–∞</button>
                <div class="btn-group">
                    <button class="btn btn-outline btn-secondary" onclick="resetServiceConfig()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    <button class="btn btn-primary" onclick="saveServiceConfig()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="logsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">–õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞</h3>
                <button class="close-btn" onclick="closeModal('logsModal')">&times;</button>
            </div>
            <div class="logs-container" id="modalLogsContainer" style="max-height: 500px;">
                <!-- –õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let servicesData = {};
        let systemData = {};
        let refreshInterval;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            loadInitialData();
            startAutoRefresh();
        });

        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('ru-RU');
        }

        function showTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            loadTabData(tabName);
        }

        async function loadInitialData() {
            try {
                await Promise.all([
                    loadServicesData(),
                    loadSystemStats()
                ]);
                
                renderOverview();
                renderServicesManagement();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            }
        }

        async function loadServicesData() {
            const response = await fetch('http://localhost:5002/api/services');
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤');
            servicesData = await response.json();
        }

        async function loadServicesWithResources() {
            const response = await fetch('http://localhost:5002/api/services?resources=true');
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏');
            servicesData = await response.json();
        }

        async function loadSystemStats() {
            const response = await fetch('http://localhost:5002/api/system/stats');
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
            systemData = await response.json();
        }

        function renderOverview() {
            renderSystemStats();
            renderServicesOverview();
        }

        function renderSystemStats() {
            const container = document.getElementById('systemStats');
            const stats = systemData.system || {};

            const cpuPercent = stats.cpu_percent || 0;
            const memoryPercent = stats.memory_percent || 0;
            const diskPercent = stats.disk_percent || 0;
            const runningContainers = systemData.docker?.running_containers || 0;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value text-${getMetricColor(cpuPercent)}">${cpuPercent.toFixed(1)}%</div>
                    <div class="stat-label">CPU</div>
                    <div class="progress">
                        <div class="progress-bar ${getProgressClass(cpuPercent)}"
                             style="width: ${cpuPercent}%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-${getMetricColor(memoryPercent)}">${memoryPercent.toFixed(1)}%</div>
                    <div class="stat-label">–ü–∞–º—è—Ç—å</div>
                    <div class="progress">
                        <div class="progress-bar ${getProgressClass(memoryPercent)}"
                             style="width: ${memoryPercent}%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-${getMetricColor(diskPercent)}">${diskPercent.toFixed(1)}%</div>
                    <div class="stat-label">–î–∏—Å–∫</div>
                    <div class="progress">
                        <div class="progress-bar ${getProgressClass(diskPercent)}"
                             style="width: ${diskPercent}%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-primary">${runningContainers}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</div>
                    <div class="mt-2">
                        <span class="status-badge status-${runningContainers > 0 ? 'running' : 'stopped'}">
                            ${runningContainers > 0 ? 'üü¢ –†–∞–±–æ—Ç–∞—é—Ç' : 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã'}
                        </span>
                    </div>
                </div>
            `;
        }

        function getProgressClass(value) {
            if (value >= 90) return 'danger';
            if (value >= 70) return 'warning';
            return 'success';
        }

        function renderServicesOverview() {
            const container = document.getElementById('servicesOverview');
            let html = '';
            
            Object.entries(servicesData).forEach(([name, service]) => {
                html += createServiceCard(name, service, false);
            });
            
            container.innerHTML = html;
        }

        function renderServicesManagement() {
            const container = document.getElementById('servicesManagement');
            let html = '';
            
            Object.entries(servicesData).forEach(([name, service]) => {
                html += createServiceCard(name, service, true);
            });
            
            container.innerHTML = html;
        }

        function createServiceCard(name, service, detailed = false) {
            const categoryClass = `category-${service.category || 'system'}`;
            const containerStatus = service.container_status || 'unknown';
            const healthStatus = service.health_status || 'unknown';

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            let cardClass = 'card service-card';
            if (detailed && service.resources) {
                const cpuPercent = service.resources.cpu_percent || 0;
                const memoryPercent = service.resources.memory_percent || 0;

                if (cpuPercent > 80 || memoryPercent > 80) {
                    cardClass += ' monitoring-card danger';
                } else if (cpuPercent > 60 || memoryPercent > 60) {
                    cardClass += ' monitoring-card warning';
                } else {
                    cardClass += ' monitoring-card success';
                }
            }

            let statusBadges = `
                <span class="status-badge status-${containerStatus === 'running' ? 'running' : 'stopped'}">
                    ${containerStatus === 'running' ? 'üü¢ –ó–∞–ø—É—â–µ–Ω' : 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
                </span>
                <span class="status-badge status-${healthStatus === 'healthy' ? 'healthy' : 'unhealthy'}">
                    ${healthStatus === 'healthy' ? '‚úÖ –ó–¥–æ—Ä–æ–≤' : '‚ùå –ü—Ä–æ–±–ª–µ–º—ã'}
                </span>
            `;

            let controls = '';
            if (detailed) {
                controls = `
                    <div class="service-controls btn-group">
                        <button class="btn btn-success btn-sm" onclick="controlService('${name}', 'start')" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å">
                            ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="controlService('${name}', 'restart')" title="–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å">
                            üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="controlService('${name}', 'stop')" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å">
                            ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="showServiceConfig('${name}')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–∞">
                            ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="showServiceLogs('${name}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤">
                            üìã –õ–æ–≥–∏
                        </button>
                    </div>
                `;
            }

            let metrics = '';
            if (service.resources && !service.resources.error) {
                const cpuPercent = service.resources.cpu_percent || 0;
                const memoryPercent = service.resources.memory_percent || 0;

                metrics = `
                    <div class="service-metrics">
                        <div class="metric">
                            <div class="metric-value text-${getMetricColor(cpuPercent)}">${cpuPercent.toFixed(1)}%</div>
                            <div class="metric-label">CPU</div>
                            <div class="progress">
                                <div class="progress-bar ${getProgressClass(cpuPercent)}" style="width: ${cpuPercent}%"></div>
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-value text-${getMetricColor(memoryPercent)}">${memoryPercent.toFixed(1)}%</div>
                            <div class="metric-label">–ü–∞–º—è—Ç—å</div>
                            <div class="progress">
                                <div class="progress-bar ${getProgressClass(memoryPercent)}" style="width: ${memoryPercent}%"></div>
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-value text-primary">${formatBytes(service.resources.network_rx || 0)}</div>
                            <div class="metric-label">–°–µ—Ç—å RX</div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="${cardClass}">
                    <div class="card-header service-header">
                        <div class="card-title service-title">${service.description || name}</div>
                        <div class="service-category ${categoryClass}">${service.category || 'system'}</div>
                    </div>
                    <div class="service-status">
                        ${statusBadges}
                    </div>
                    ${controls}
                    ${metrics}
                </div>
            `;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getProgressClass(percentage) {
            if (percentage >= 80) return 'danger';
            if (percentage >= 60) return 'warning';
            return 'success';
        }

        function getMetricColor(percentage) {
            if (percentage >= 80) return 'danger';
            if (percentage >= 60) return 'warning';
            return 'success';
        }

        // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ UX
        function refreshMonitoring() {
            showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...', 'info');
            loadServicesWithResources().then(() => {
                loadMonitoringData();
                showNotification('–î–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
            });
        }

        function exportMetrics() {
            const data = {
                timestamp: new Date().toISOString(),
                services: servicesData,
                system: systemData
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `metrics-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('–ú–µ—Ç—Ä–∏–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }

        function resetServiceConfig() {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏?')) {
                const modal = document.getElementById('configModal');
                const serviceName = modal.getAttribute('data-service');
                showServiceConfig(serviceName);
                showNotification('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±—Ä–æ—à–µ–Ω–∞', 'warning');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏
        async function controlService(serviceName, action) {
            try {
                const response = await fetch(`http://localhost:5002/api/service/${serviceName}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`–°–µ—Ä–≤–∏—Å ${serviceName}: ${action} –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ`, 'success');
                    setTimeout(loadInitialData, 2000); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                } else {
                    showNotification(`–û—à–∏–±–∫–∞ ${action} —Å–µ—Ä–≤–∏—Å–∞ ${serviceName}: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function startAllServices() {
            try {
                const response = await fetch('http://localhost:5002/api/services/start-all', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showNotification('–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã', 'success');
                    setTimeout(loadInitialData, 5000);
                } else {
                    showNotification(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function restartAllServices() {
            try {
                const response = await fetch('http://localhost:5002/api/services/restart-all', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showNotification('–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã', 'success');
                    setTimeout(loadInitialData, 5000);
                } else {
                    showNotification(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function stopAllServices() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã?')) return;

            try {
                const response = await fetch('http://localhost:5002/api/services/stop-all', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showNotification('–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'warning');
                    setTimeout(loadInitialData, 3000);
                } else {
                    showNotification(`–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'overview':
                    loadInitialData();
                    break;
                case 'services':
                    loadServicesData().then(renderServicesManagement);
                    break;
                case 'monitoring':
                    // –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
                    break;
                case 'logs':
                    // –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
                    break;
                case 'config':
                    // –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
                    break;
                case 'backups':
                    // –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
                    break;
            }
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && (activeTab.id === 'overview' || activeTab.id === 'services')) {
                    loadInitialData();
                }
            }, 30000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–æ–≥–∞–º–∏
        async function showServiceLogs(serviceName) {
            try {
                const response = await fetch(`http://localhost:5002/api/service/${serviceName}/logs/stream?lines=100`);
                const result = await response.json();

                if (result.logs) {
                    document.getElementById('modalLogsContainer').textContent = result.logs.join('\n');
                    document.getElementById('logsModal').style.display = 'block';
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤', 'error');
                }
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function loadServiceLogs() {
            const serviceName = document.getElementById('logServiceSelect').value;
            if (!serviceName) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å', 'warning');
                return;
            }

            try {
                const response = await fetch(`http://localhost:5002/api/service/${serviceName}/logs/stream?lines=200`);
                const result = await response.json();

                if (result.logs) {
                    document.getElementById('logsContainer').textContent = result.logs.join('\n');
                } else {
                    document.getElementById('logsContainer').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤';
                }
            } catch (error) {
                document.getElementById('logsContainer').textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        function clearLogs() {
            document.getElementById('logsContainer').textContent = '–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã';
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
        async function showServiceConfig(serviceName) {
            try {
                const response = await fetch(`http://localhost:5002/api/service/${serviceName}/config`);
                const config = await response.json();

                let html = '';

                // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
                if (config.env_vars) {
                    html += '<h4>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:</h4>';
                    html += '<div class="form-group">';
                    html += '<textarea class="form-control" id="envVars" rows="10">';
                    Object.entries(config.env_vars).forEach(([key, value]) => {
                        if (!key.startsWith('_')) {
                            html += `${key}=${value}\n`;
                        }
                    });
                    html += '</textarea></div>';
                }

                // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
                if (config.config_files) {
                    Object.entries(config.config_files).forEach(([filename, fileData]) => {
                        html += `<h4>–§–∞–π–ª: ${filename}</h4>`;
                        html += '<div class="form-group">';
                        html += `<textarea class="form-control config-file" data-filename="${filename}" rows="15">`;
                        html += fileData.content || JSON.stringify(fileData.parsed, null, 2);
                        html += '</textarea></div>';
                    });
                }

                document.getElementById('configModalBody').innerHTML = html;
                document.getElementById('configModal').setAttribute('data-service', serviceName);
                document.getElementById('configModal').style.display = 'block';

            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ${error.message}`, 'error');
            }
        }

        async function loadServiceConfig() {
            const serviceName = document.getElementById('configServiceSelect').value;
            if (!serviceName) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å', 'warning');
                return;
            }

            try {
                const response = await fetch(`http://localhost:5002/api/service/${serviceName}/config`);
                const config = await response.json();

                let html = `<h3>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞: ${serviceName}</h3>`;

                if (config.env_vars) {
                    html += '<h4>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:</h4>';
                    html += '<pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto;">';
                    Object.entries(config.env_vars).forEach(([key, value]) => {
                        if (!key.startsWith('_')) {
                            html += `${key}=${value}\n`;
                        }
                    });
                    html += '</pre>';
                }

                if (config.config_files) {
                    Object.entries(config.config_files).forEach(([filename, fileData]) => {
                        html += `<h4>–§–∞–π–ª: ${filename}</h4>`;
                        html += '<pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; max-height: 300px;">';
                        html += fileData.content || JSON.stringify(fileData.parsed, null, 2);
                        html += '</pre>';
                    });
                }

                html += `<button class="btn btn-primary" onclick="showServiceConfig('${serviceName}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`;

                document.getElementById('configContainer').innerHTML = html;

            } catch (error) {
                document.getElementById('configContainer').innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ${error.message}</p>`;
            }
        }

        async function saveServiceConfig() {
            const modal = document.getElementById('configModal');
            const serviceName = modal.getAttribute('data-service');

            try {
                const configData = {
                    restart_service: true
                };

                // –°–æ–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
                const envTextarea = document.getElementById('envVars');
                if (envTextarea) {
                    const envVars = {};
                    envTextarea.value.split('\n').forEach(line => {
                        if (line.trim() && line.includes('=')) {
                            const [key, ...valueParts] = line.split('=');
                            envVars[key.trim()] = valueParts.join('=').trim();
                        }
                    });
                    configData.env_vars = envVars;
                }

                // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
                const configFiles = {};
                document.querySelectorAll('.config-file').forEach(textarea => {
                    const filename = textarea.getAttribute('data-filename');
                    configFiles[filename] = { content: textarea.value };
                });
                if (Object.keys(configFiles).length > 0) {
                    configData.config_files = configFiles;
                }

                const response = await fetch(`http://localhost:5002/api/service/${serviceName}/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏ —Å–µ—Ä–≤–∏—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω', 'success');
                    closeModal('configModal');
                    setTimeout(loadInitialData, 3000);
                } else {
                    showNotification(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${result.error}`, 'error');
                }

            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±—ç–∫–∞–ø–∞–º–∏
        async function createBackup() {
            const serviceName = document.getElementById('backupServiceSelect').value;
            if (!serviceName) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å', 'warning');
                return;
            }

            try {
                const response = await fetch(`http://localhost:5002/api/service/${serviceName}/backup`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showNotification(`–ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: ${result.backup_id}`, 'success');
                    loadBackups();
                } else {
                    showNotification(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function loadBackups() {
            try {
                const response = await fetch('http://localhost:5002/api/backups');
                const result = await response.json();

                let html = '<div class="services-grid">';

                if (result.backups && result.backups.length > 0) {
                    result.backups.forEach(backup => {
                        html += `
                            <div class="service-card">
                                <div class="service-header">
                                    <div class="service-title">${backup.service}</div>
                                    <div class="service-category category-system">backup</div>
                                </div>
                                <p><strong>ID:</strong> ${backup.id}</p>
                                <p><strong>–î–∞—Ç–∞:</strong> ${backup.date}</p>
                                <p><strong>–í—Ä–µ–º—è:</strong> ${backup.time}</p>
                                <p><strong>–§–∞–π–ª—ã:</strong> ${backup.files.join(', ')}</p>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-danger btn-sm" onclick="deleteBackup('${backup.id}')">
                                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p>–ë—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                }

                html += '</div>';
                document.getElementById('backupsContainer').innerHTML = html;

            } catch (error) {
                document.getElementById('backupsContainer').innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—ç–∫–∞–ø–æ–≤: ${error.message}</p>`;
            }
        }

        async function deleteBackup(backupId) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –±—ç–∫–∞–ø ${backupId}?`)) return;

            // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–∞ (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å endpoint –≤ API)
            showNotification('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –±—ç–∫–∞–ø–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'warning');
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        function loadMonitoringData() {
            const container = document.getElementById('monitoringGrid');
            let html = '';

            Object.entries(servicesData).forEach(([name, service]) => {
                if (service.resources && !service.resources.error) {
                    html += `
                        <div class="service-card">
                            <div class="service-header">
                                <div class="service-title">${service.description || name}</div>
                                <div class="service-category category-${service.category}">${service.category}</div>
                            </div>
                            <div class="service-metrics">
                                <div class="metric">
                                    <div class="metric-value">${service.resources.cpu_percent?.toFixed(1) || 0}%</div>
                                    <div class="metric-label">CPU</div>
                                    <div class="progress">
                                        <div class="progress-bar ${getProgressClass(service.resources.cpu_percent)}"
                                             style="width: ${service.resources.cpu_percent || 0}%"></div>
                                    </div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value">${service.resources.memory_percent?.toFixed(1) || 0}%</div>
                                    <div class="metric-label">–ü–∞–º—è—Ç—å</div>
                                    <div class="progress">
                                        <div class="progress-bar ${getProgressClass(service.resources.memory_percent)}"
                                             style="width: ${service.resources.memory_percent || 0}%"></div>
                                    </div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value">${formatBytes(service.resources.network_rx || 0)}</div>
                                    <div class="metric-label">–°–µ—Ç—å RX</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value">${formatBytes(service.resources.network_tx || 0)}</div>
                                    <div class="metric-label">–°–µ—Ç—å TX</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value">${formatBytes(service.resources.memory_usage || 0)}</div>
                                    <div class="metric-label">–ü–∞–º—è—Ç—å (–∞–±—Å.)</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-value">${service.resources.status || 'unknown'}</div>
                                    <div class="metric-label">–°—Ç–∞—Ç—É—Å</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html || '<p>–î–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>';
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é loadTabData
        function loadTabData(tabName) {
            switch(tabName) {
                case 'overview':
                    loadInitialData();
                    break;
                case 'services':
                    loadServicesData().then(renderServicesManagement);
                    break;
                case 'monitoring':
                    loadServicesWithResources().then(loadMonitoringData);
                    break;
                case 'logs':
                    populateServiceSelects();
                    break;
                case 'config':
                    populateServiceSelects();
                    break;
                case 'backups':
                    populateServiceSelects();
                    loadBackups();
                    break;
            }
        }

        function populateServiceSelects() {
            const services = Object.keys(servicesData);

            ['logServiceSelect', 'configServiceSelect', 'backupServiceSelect'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å</option>';
                    services.forEach(service => {
                        select.innerHTML += `<option value="${service}">${servicesData[service].description || service}</option>`;
                    });
                }
            });
        }
    </script>
</body>
</html>
